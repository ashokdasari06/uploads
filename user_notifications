import boto3
import csv
import os
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

s3_client = boto3.client("s3")
ses_client = boto3.client("ses", region_name="us-east-1")

SENDER_EMAIL = "CloudEngineers@xpanse.com"
SUBJECT = "Action Required: Your Amazon Workspace Is Scheduled for Deletion"

BODY_TEMPLATE = """Hello {username},

Your Amazon Workspace with ID {workspace_id} has not been accessed in over 60 days.

It is scheduled for deletion in **7 days** if no activity is detected.

If you still need this workspace, please log in before the deadline.

Regards,  
Cloud Engineering
"""

def lambda_handler(event, context):
    print("Received event:", event)

    # 1. Extract S3 info from event
    bucket = event["Records"][0]["s3"]["bucket"]["name"]
    key = event["Records"][0]["s3"]["object"]["key"]

    # 2. Download CSV from S3 to /tmp
    download_path = f"/tmp/{os.path.basename(key)}"
    s3_client.download_file(bucket, key, download_path)

    # 3. Read CSV
    with open(download_path, newline="") as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            workspace_id = row.get("WorkspaceId")
            username = row.get("UserName")
            email = row.get("EMail")

            if not email:
                print(f"Skipping {workspace_id}: no email found")
                continue

            body = BODY_TEMPLATE.format(username=username, workspace_id=workspace_id)

            # 4. Build email
            msg = MIMEMultipart()
            msg["Subject"] = SUBJECT
            msg["From"] = SENDER_EMAIL
            msg["To"] = email
            msg.attach(MIMEText(body, "plain"))

            # 5. Send email
            try:
                ses_client.send_raw_email(
                    Source=SENDER_EMAIL,
                    Destinations=[email],
                    RawMessage={"Data": msg.as_string()},
                )
                print(f"✅ Email sent to {email} for {workspace_id}")
            except Exception as e:
                print(f"❌ Failed to send email to {email}: {e}")
